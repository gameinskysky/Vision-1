%% Main Postprocessing routine
% Oktober 2015
% author: Julian Surber, ETH Zurich

% This file loads data from a csv file of a ros session to analyse the
% performance of a SLAM algorithm like ROVIO, PTAM, OKVIS, ...
%
% The csv file must provide a header row describing the different signals
% 
% The following signals must be provided by the csv file
%       timestamp
%       

% add subfolders to matlab path
clear all
close all
clc
file=which('main.m');
[scriptPath] = fileparts(file);
cd(scriptPath);
addpath(genpath(scriptPath))

% load data
filename = uigetfile('*.csv','Select the .csv file containing ground_truth pose');
ground_truth = readtable(filename);
filename = uigetfile('*.csv','Select the .csv file containing the rovio estimated pose');
rovio = readtable(filename);

% convert and time-align

%% quaternion to euler convertion
% ground_truth
gt_q = [ground_truth.x_1, ground_truth.y_1, ground_truth.z_1, ground_truth.w];
[gt_r1,gt_r2,gt_r3] = quat2angle(gt_q);

% rovio
ro_q = [rovio.x_1, rovio.y_1, rovio.z_1, rovio.w];
[ro_r1,ro_r2,ro_r3] = quat2angle(ro_q);

% % ground_truth
gt_q = [ground_truth.x_1, ground_truth.y_1, ground_truth.z_1, ground_truth.w];
R_vb = quat2dcm(gt_q(1,:)); % index v for vicon, b for body
r_vicon = [ground_truth.x,ground_truth.y,ground_truth.z];

% rovio
ro_q = [rovio.x_1, rovio.y_1, rovio.z_1, rovio.w];
R_rb = quat2dcm(ro_q(1,:)); % index r for rovio
r_rovio = [rovio.x,rovio.y,rovio.z];

% rovio wrt vicon
R_vr = R_vb*R_rb';



% describe all signals wrt world frame
% rovio: position:    ro_vicon = R_vr * r_rovio
%        orientation: ang_vicon = dcm3angle(R_vr * Rrb)
% vicon: position:    r_vicon
%        orientation: ang_world = dcm3angle(R_bv)
R_wr = R_rw';
for i=1:length(r_rovio)
    ro_world = R_wr*ro_rovio;
    ro_ang = dcm2ang(
end

%% plot
time_gt = ground_truth.rosbagTimestamp;
time_ro = rovio.rosbagTimestamp;
%
% init figure
scrsz = get(groot,'ScreenSize');
figure('Name','Rovio analysis','NumberTitle','off', ...
    'Position',[1 1 scrsz(3) scrsz(4)]);
% 
ha(1) = subplot(321);
plot(time_gt,ground_truth.x)
hold on
plot(time_ro,-rovio.x)
title('x tracking','FontSize',12)
h_legend = legend('ground truth', '- rovio');
set(h_legend,'FontSize',8)
xlabel('[s]','FontSize',12)
ylabel('[m]','FontSize',12)
grid on

ha(2) = subplot(323);
plot(time_gt,ground_truth.y)
hold on
plot(time_ro,-rovio.y)
title('y tracking','FontSize',12)
h_legend = legend('ground truth', '- rovio');
set(h_legend,'FontSize',8)
xlabel('[s]','FontSize',12)
ylabel('[m]','FontSize',12)
grid on

ha(3) = subplot(325);
plot(time_gt,ground_truth.z)
hold on
plot(time_ro,rovio.z)
title('z tracking','FontSize',12)
h_legend = legend('ground truth', 'rovio');
set(h_legend,'FontSize',8)
xlabel('[s]','FontSize',12)
ylabel('[m]','FontSize',12)
grid on

ha(4) = subplot(322);
plot(time_gt,gt_r1)
hold on
plot(time_ro,ro_r1)
title('euler r1 tracking','FontSize',12)
h_legend = legend('ground truth', 'rovio');
set(h_legend,'FontSize',8)
xlabel('[s]','FontSize',12)
ylabel('[rad]','FontSize',12)
grid on

ha(4) = subplot(324);
plot(time_gt,gt_r2)
hold on
plot(time_ro,ro_r2)
title('euler r2 tracking','FontSize',12)
h_legend = legend('ground truth', 'rovio');
set(h_legend,'FontSize',8)
xlabel('[s]','FontSize',12)
ylabel('[rad]','FontSize',12)
grid on

ha(4) = subplot(326);
plot(time_gt,gt_r3)
hold on
plot(time_ro,ro_r3)
title('euler r3 tracking','FontSize',12)
h_legend = legend('ground truth', 'rovio');
set(h_legend,'FontSize',8)
xlabel('[s]','FontSize',12)
ylabel('[rad]','FontSize',12)
grid on


linkaxes(ha,'x')
